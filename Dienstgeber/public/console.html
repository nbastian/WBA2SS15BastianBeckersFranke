<!DOCTYPE html>
<html>
	<head>
		<title>PerPla Personalplanung</title>

		<meta charset="utf-8">
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		
		<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
		<link href="//maxcdn.bootstrapcdn.com/bootswatch/3.2.0/lumen/bootstrap.min.css" rel="stylesheet">
		
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.8.3/underscore-min.js"></script>
	
		<script>
			var items = null;
			
			$.postJSON = function(url, data, callback) {
				return jQuery.ajax({
			        'type': 'POST',
			        'url': url,
			        'contentType': 'application/json',
			        'data': JSON.stringify(data),
			        'dataType': 'json',
			        'success': callback
			    });
			};
			
			$.putJSON = function(url, data, callback) {
				return jQuery.ajax({
			        'type': 'PUT',
			        'url': url,
			        'contentType': 'application/json',
			        'data': JSON.stringify(data),
			        'dataType': 'json',
			        'success': callback
			    });
			};
			
			$.deleteJSON = function(url, data, callback) {
				return jQuery.ajax({
			        'type': 'DELETE',
			        'url': url,
			        'contentType': 'application/json',
			        'data': JSON.stringify(data),
			        'dataType': 'json',
			        'success': callback
			    });
			};
			
			
			
			$.serializeObject = function(form) {
				var formdata = $(form).serializeArray();
				var data = {};
				
				$(formdata).each(function(index, obj){
				    data[obj.name] = obj.value;
				});
				
				return data;
			}
			
			$(function() {
				$('form.form-newuser').on('submit', function(e) {
					e.preventDefault();
					var id = $('input[name="id"]', this).val();
					
					var callback = function() {
						$('form.form-newuser').get(0).reset();
						getLists();
					}
					
					if (id == '') {
						// neuer user
						
						$.postJSON('/user', $.serializeObject(this), callback);
					} else {
						// bestehender user 
						
						$.putJSON('/user/' + id, $.serializeObject(this), callback);
					}
				});
				
				(getLists = function() {
					$.getJSON('/user', function(resp) {
						items = resp;
						var template = $('#table-user').html();
						$('.usertable-target').html(_.template(template, { items: items }));
					});

				})();
				
				// bind events
				$('.btn-refresh').on('click', function(e) {
					e.preventDefault();
					getLists();
				});
				
				$('.usertable-target').on('click', '.btn-delete', function(e) {
					e.preventDefault();
					
					var userId = $(this).closest('tr').data('rowid');
					
					$.deleteJSON('/user/' + userId, [], function(resp) {
						getLists();
					});
				});
				
				$('.usertable-target').on('click', '.btn-edit', function(e) {
					e.preventDefault();
					
					var userId = $(this).closest('tr').data('rowid');
					
					$.getJSON('/user/' + userId, function(resp) {
						$('form.form-newuser input[name="id"]').val(resp.id);
						$('form.form-newuser input[name="username"]').val(resp.username);
						$('form.form-newuser input[name="email"]').val(resp.email);
						$('form.form-newuser input[name="password"]').val('');
						
					});
				});
			});
		</script>
	</head>
	<body>
		<script type="text/template" id="table-user">
			<table class="table table-striped table-user">
				<thead>
					<tr>
						<th>ID</th>
						<th>Benutzername</th>
						<th>E-Mail</th>
						<th></th>
					</tr>
				</thead>
				<tbody>
					<%
					_.each(items, function(item, key, list) {
					%>
						<tr data-rowid="<%- item.id %>">
							<td><%- item.id %></td>
							<td><%- item.username %></td>
							<td><%- item.email %></td>
							
							<td>
								<div class="btn-group">
									<a href="#" class="btn btn-default btn-sm btn-edit"><i class="fa fa-pencil"></i></a>
									<a href="#" class="btn btn-danger btn-sm btn-delete"><i class="fa fa-trash"></i></a>
								</div>
							</td>
						</tr>
					<%
					});
					%>
				</tbody>
			</table>
		</script>

		<div class="container">
			<h1>Nutzer</h1>
			<div class="row">
				<div class="col-md-4">
					<h2>hinzuf√ºgen</h2>
		
					<form class="form-horizontal form-newuser">
						<div class="form-group">
							<label class="col-sm-4 control-label">ID</label>
							<div class="col-sm-8">
								<input type="text" name="id" class="form-control" readonly>
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4 control-label">Benutzername</label>
							<div class="col-sm-8">
								<input type="text" name="username" class="form-control">
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4 control-label">E-Mail</label>
							<div class="col-sm-8">
								<input type="email" name="email" class="form-control">
							</div>
						</div>
						<div class="form-group">
							<label class="col-sm-4 control-label">Passwort</label>
							<div class="col-sm-8">
								<input type="password" name="password" class="form-control">
							</div>
						</div>
						<!-- <div class="form-group">
							<div class="col-sm-offset-4 col-sm-8">
								<div class="checkbox">
									<label>
										<input type="checkbox" name="isAdmin">
										Nutzer ist Administrator.
									</label>
								</div>
							</div>
						</div> -->
						<div class="form-group">
							<div class="col-sm-offset-4 col-sm-8">
								<button type="submit" class="btn btn-default">Speichern</button>
							</div>
						</div>
					</form>
				</div>
				<div class="col-md-8">
					<h2>Liste <a href="#" class="btn btn-default btn-sm btn-refresh"><i class="fa fa-refresh"></i></a></h2>
					
					<div class="usertable-target"></div>
				</div>
			</div>
		</div>
	</body>
</html>